name: Triage New Issue

on:
  issues:
    types: [opened]
  workflow_dispatch:
    inputs:
      issue-number:
        description: "Issue number to triage"
        required: true
        type: number

permissions:
  contents: read
  issues: read

# Cancel in-progress runs for the same issue
concurrency:
  group: triage-${{ github.event.issue.number || inputs.issue-number }}
  cancel-in-progress: true

jobs:
  triage:
    runs-on: ubuntu-latest
    # For issue events: skip PRs and bot-created issues. Always run for workflow_dispatch.
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (!github.event.issue.pull_request &&
      github.event.issue.user.type != 'Bot')
    timeout-minutes: 15
    steps:
      - name: Resolve issue number
        id: issue
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "number=${{ inputs.issue-number }}" >> "$GITHUB_OUTPUT"
          else
            echo "number=${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout (sparse â€” just the skill and opencode config)
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .github/skills
            .github/opencode.json

      - name: Install OpenCode
        run: |
          npm install -g opencode-ai
          cp .github/opencode.json ./opencode.json

      - name: Fetch issue data
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ISSUE=${{ steps.issue.outputs.number }}
          mkdir -p data/${ISSUE}

          gh issue view ${ISSUE} \
            --repo ${{ github.repository }} \
            --json number,title,body,comments,createdAt,updatedAt,labels,state,author \
            > data/${ISSUE}/context.json

      - name: Analyze issue with OpenCode
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_AI_GATEWAY_ACCOUNT_ID }}
          CLOUDFLARE_GATEWAY_ID: ${{ secrets.CF_AI_GATEWAY_NAME }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_AI_GATEWAY_TOKEN }}
        run: |
          ISSUE=${{ steps.issue.outputs.number }}
          REPO=${{ github.repository }}

          opencode run \
            --print-logs \
            "Analyze GitHub issue ${REPO}#${ISSUE} using the skill at .github/skills/issue-review.md.

          The issue data has been pre-fetched to data/${ISSUE}/context.json.
          Read it with the read tool and follow the triage process.

          Create:
          - data/${ISSUE}/report.md (full report)
          - data/${ISSUE}/summary.md (single tab-separated summary line)
          "

      - name: Validate generated files (no-dashboard mode)
        run: |
          ISSUE=${{ steps.issue.outputs.number }}

          if [ ! -f "data/${ISSUE}/report.md" ]; then
            echo "::error::report.md was not generated"
            exit 1
          fi
          if [ ! -f "data/${ISSUE}/summary.md" ]; then
            echo "::error::summary.md was not generated"
            exit 1
          fi

          echo "Generated artifacts for issue #${ISSUE}:"
          ls -la "data/${ISSUE}"

      - name: Upload triage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: triage-${{ steps.issue.outputs.number }}
          path: data/${{ steps.issue.outputs.number }}/
          if-no-files-found: error
